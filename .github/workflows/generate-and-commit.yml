name: Generate and Commit Danmatsu + Summaries

on:
  schedule:
    - cron: '0 6,10,14,18,22 * * *'    # â° æ¯æ—¥5å›: æ–­æœ«é­”ç”Ÿæˆ
    - cron: '0 23 * * 0'               # ğŸ—’ï¸ æ¯é€±æ—¥æ›œ23æ™‚: noteç”¨ã¾ã¨ã‚ç”Ÿæˆ
    - cron: '0 1 1 * *'                # ğŸ“° æ¯æœˆ1æ—¥1æ™‚: zineç”¨ã¾ã¨ã‚ç”Ÿæˆ
  workflow_dispatch:                   # ğŸ› ï¸ æ‰‹å‹•å®Ÿè¡Œå¯¾å¿œ

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“ Checkout repository
        uses: actions/checkout@v3

      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: ğŸ“¦ Install OpenAI SDK
        run: pip install openai==0.28

      - name: ğŸ§  Run Danmatsu Generator
        if: github.event.schedule == '0 6,10,14,18,22 * * *' || github.event_name == 'workflow_dispatch'
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: python generate_danmatsu.py

      - name: ğŸ—’ï¸ Run Weekly Note Summary
        if: github.event.schedule == '0 23 * * 0'
        run: python generate_note_summary.py

      - name: ğŸ“° Run Monthly Zine Summary
        if: github.event.schedule == '0 1 1 * *'
        run: python generate_zine_summary.py

      - name: ğŸ’¾ Commit and Push Changes
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          git config --global user.name "syntax-death"
          git config --global user.email "no-reply@syntax.death"
          git remote set-url origin https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }}
          git pull --ff-only origin main || echo "No fast-forward possible, skipping pull."

          git add .
          CHANGES=$(git diff --cached --name-only)
          if [ -z "$CHANGES" ]; then
            echo "No changes to commit."
          else
            git commit -m "ğŸ¤– Auto-update: danmatsu + note/zine summary"
            git push origin HEAD:main
          fi

      - name: ğŸ“¡ Notify Poemkun Bot via GitHub Dispatch
        env:
          POEMKUN_PAT: ${{ secrets.POEMKUN_PAT }}
        run: |
          curl -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${POEMKUN_PAT}" \
            https://api.github.com/repos/groovy1985/poem_kun/dispatches \
            -d '{"event_type":"post_update_trigger","client_payload":{"repo":"last-words","trigger":"dispatch"}}'
